# Микросервис аутентификации

## Описание

Этот микросервис предоставляет функциональность для:
- Регистрации и аутентификации пользователей с JWT токенами
- Управления сессиями (ограничение активных сессий, refresh токены)
- Защиты от brute-force атак (блокировка при превышении попыток входа)
- Интеграции с другими сервисами через Kafka
- Кэширования данных в Redis

---

## Основные функции

### Аутентификация
- Регистрация новых пользователей (`/auth/register`)
- Вход с получением access/refresh токенов (`/auth/login`)
- Обновление токенов (`/auth/refresh_token`)
- Выход с инвалидацией токенов (`/auth/logout`)

### Безопасность
- Ограничение активных сессий (MAX_ACTIVE_SESSIONS = 5)
- Блокировка при 5 неудачных попытках входа на 5 минут
- Хеширование паролей (bcrypt)

### Интеграция
- Отправка событий в Kafka при регистрации
- Кэширование данных пользователей в Redis

---

## Технологический стек

- **Python 3.13.3**
- **FastAPI** + **Uvicorn**
- **SQLAlchemy (async)** - работа с базой данных
- **PostgreSQL** - основное хранилище данных
- **Redis** - кэширование
- **Kafka** + **confluent-kafka**
- **Pydantic** - валидация данных
- **JWT** - аутентификация
- **Pytest** - тестирование

---

## Запуск сервиса

### Требования
- Docker и Docker Compose
- Python 3.10+

### Установка
1. Клонируйте репозиторий
2. Выполните: `pip install -r requirements.txt`
3. Создайте файл `.env` и `.test.env`(для тестирования) на основе `.env.example`
4. Заполните необходимые переменные окружения

### Запуск
```bash
docker-compose up -d
```

Сервис будет доступен на `http://localhost:8000`

---

## API Endpoints

### Аутентификация
| Метод | Эндпоинт              | Описание                          |
|-------|-----------------------|-----------------------------------|
| POST  | `/auth/register`      | Регистрация нового пользователя   |
| POST  | `/auth/login`         | Вход (получение токенов)          |
| POST  | `/auth/refresh_token` | Обновление пары токенов           |
| POST  | `/auth/logout`        | Выход (инвалидация токенов)       |

---

## Конфигурация
Основные настройки сервиса находятся в:
- `src/config.py` - основные параметры сервиса
- `.env` - переменные окружения

## Тестирование
Для запуска тестов:
```bash
pytest
```
Для запуска тестов через Docker:
```bash
docker-compose --env-file .test.env up -d
```
```bash
docker-compose --env-file .test.env exec app pytest
```

Тесты покрывают:
- Работу эндпоинтов API
- Логику аутентификации
- Интеграцию с Redis и Kafka
- Обработку ошибок

---

## Логирование
Логи сохраняются в файл `logs/auth_service.log` с ротацией по дням.

## Данные в Kafka

### Отправляемые сообщения (топик `uploading_data`)
```python
{
  "key": "new_user",
  "value": {
    "user_id": int,
    "username": str,
    "full_name": str,
    "created_at": str  # ISO format
  }
}
```

---

## Хранение в Redis

### 1. Кэш пользователя
**Ключ:** `user:{user_id}`  
**Значение:**  
```json
{"user_id": 123, "username": "user@example.com"}
```
**TTL:** 30 минут (ACCESS_TOKEN_EXPIRE_MINUTES)

### 2. Блокировки входа
**Ключ:** `login_block:{ip}:{username}`  
**Значение:** `1`  (метка)  
**Назначение:** Блокировка при превышении попыток входа.  
**TTL:** `LOGIN_BLOCK_TIME` (300 сек.)  

### 3. Счетчик попыток
**Ключ:** `login_attempt:{ip}:{username}`  
**Значение:** `3` (количество попыток)  
**TTL:** `LOGIN_BLOCK_TIME` (300 сек.) 

---

### Общий readme: https://github.com/IvanShankin/API_handler_resume_general_readme