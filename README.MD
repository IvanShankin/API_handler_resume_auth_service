# Микросервис аутентификации

## Описание

Этот микросервис предоставляет функциональность для:
- Регистрации и аутентификации пользователей с JWT токенами
- Управления сессиями (ограничение активных сессий, refresh токены)
- Защиты от brute-force атак (блокировка при превышении попыток входа)
- Интеграции с другими сервисами через Kafka
- Кэширования данных в Redis

---

## Основные функции

### Аутентификация
- Регистрация новых пользователей (`/auth/register`)
- Вход с получением access/refresh токенов (`/auth/login`)
- Обновление токенов (`/auth/refresh_token`)
- Выход с инвалидацией токенов (`/auth/logout`)

### Безопасность
- Ограничение активных сессий (config.max_active_sessions = 10)
- Блокировка при 15 неудачных попытках входа на 5 минут (config.max_attempts_enter = 15)
- Хеширование паролей (bcrypt)

### Интеграция
- Отправка событий в Kafka при регистрации
- Кэширование данных пользователей в Redis

---

## Технологический стек

- **Python 3.13.3**
- **FastAPI** + **Uvicorn**
- **SQLAlchemy (async)** - работа с базой данных
- **PostgreSQL** - основное хранилище данных
- **Redis** - кэширование
- **Kafka** + **confluent-kafka**
- **Pydantic** - валидация данных
- **JWT** - аутентификация
- **Pytest** - тестирование

---

## Запуск сервиса

### Требования
- Docker и Docker Compose
- Python 3.10+

### Установка
1. Клонируйте репозиторий
2. Выполните: `pip install -r requirements.txt`
3. Создайте файл `.env` и `.test.env`(для тестирования) на основе `.env.example`
4. Заполните необходимые переменные окружения

### Запуск
```bash
docker-compose up -d
```

Сервис будет доступен на `http://localhost:8000`

---

## API Endpoints

### Аутентификация
| Метод | Эндпоинт              | Описание                          |
|-------|-----------------------|-----------------------------------|
| POST  | `/auth/register`      | Регистрация нового пользователя   |
| POST  | `/auth/login`         | Вход (получение токенов)          |
| POST  | `/auth/refresh_token` | Обновление пары токенов           |
| POST  | `/auth/logout`        | Выход (инвалидация токенов)       |

---

## Конфигурация
Основные настройки сервиса находятся в:
- `src/service/config/shemas` - основные параметры сервиса
- `.env` - переменные окружения

## Тестирование
Для запуска тестов:
```bash
pytest
```
Для запуска тестов через Docker:
```bash
docker-compose --env-file .test.env up -d
```
```bash
docker-compose --env-file .test.env exec app pytest
```

---

## Логирование
Логи сохраняются в файл `media/logs/auth_service.log` с ротацией по дням.

## Данные в Kafka

### Отправляемые сообщения (топик `uploading_data`)
```json
{
  "key": "new_user",
  "value": {
    "user_id": "int",
    "username": "str",
    "full_name": "str",
    "created_at": "str"  # ISO format
  }
}
```

---

### Общий readme: https://github.com/IvanShankin/API_handler_resume_general_readme